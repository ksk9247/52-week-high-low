<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>52-Week Position — Minimal</title>
<style>
  :root{--bg:#0f172a;--panel:#0b1220;--text:#e5e7eb;--muted:#94a3b8;--accent:#22d3ee;--ok:#86efac;--warn:#fca5a5;--border:rgba(255,255,255,.12)}
  *{box-sizing:border-box}
  body{margin:0;padding:24px;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;background:#0f172a;color:var(--text)}
  .container{max-width:900px;margin:0 auto}
  .card{background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.02));border:1px solid var(--border);border-radius:18px;padding:18px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  input[type=url],select{flex:1 1 520px;padding:12px 14px;border-radius:12px;border:1px solid var(--border);background:var(--panel);color:var(--text);font-size:1rem;outline:none}
  input:focus,select:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(34,211,238,.15)}
  button{cursor:pointer;border:0;padding:12px 16px;border-radius:12px;font-weight:700;background:var(--accent);color:#05333a}
  button.secondary{background:transparent;color:var(--muted);border:1px solid var(--border)}
  .ghost{background:transparent;color:var(--text);border:1px solid var(--border)}
  .result{margin-top:14px;padding:14px;border-radius:14px;border:1px dashed var(--border)}
  .big{font-size:2.1rem;font-weight:800}
  .pill{padding:4px 10px;border-radius:999px;font-size:.8rem}
  .ok{background:var(--ok);color:#05301a}.warn{background:var(--warn);color:#3a0b0b}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px}
  .kv{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;background:rgba(255,255,255,.03);border:1px solid var(--border);border-radius:10px}
  .bar{height:12px;border-radius:999px;background:rgba(255,255,255,.08);position:relative;overflow:hidden;margin-top:10px}
  .bar>.fill{position:absolute;left:0;top:0;bottom:0;background:linear-gradient(90deg,#60a5fa,#22d3ee,#34d399);width:0%;transition:width .3s ease}
  .bar>.thumb{position:absolute;top:-4px;width:20px;height:20px;border-radius:50%;background:#fff;box-shadow:0 4px 12px rgba(0,0,0,.5);transform:translateX(-50%);left:0%;transition:left .3s ease}
  .spacer{flex:1}
  .idx{font-size:.9rem;color:var(--muted)}
</style>
</head>
<body>
<div class="container">
  <div class="card">
    <div class="row">
      <input id="csvUrl" type="url" placeholder="Paste Published link (pubhtml or CSV)" />
      <button id="load">Fetch</button>
      <button id="clear" class="secondary">Clear</button>
    </div>

    <div class="row" style="margin-top:10px">
      <button id="prev" class="ghost">◀ Prev</button>
      <select id="ticker" disabled>
        <option value="">Select ticker…</option>
      </select>
      <button id="next" class="ghost">Next ▶</button>
      <div class="spacer"></div>
      <span id="counter" class="idx"></span>
      <button id="recalc" class="secondary" disabled>Recalculate</button>
    </div>

    <div id="output" class="result" hidden>
      <div class="row" style="justify-content:space-between;align-items:center">
        <span style="color:var(--muted);font-size:.9rem">Position between 52W Low ↔ 52W High</span>
        <span id="badge" class="pill"></span>
      </div>
      <div id="percent" class="big">—</div>
      <div class="bar"><div class="fill"></div><div class="thumb"></div></div>
      <div class="grid">
        <div class="kv"><span style="color:var(--muted)">Ticker</span><strong id="oTicker">—</strong></div>
        <div class="kv"><span style="color:var(--muted)">Current</span><strong id="oCurrent">—</strong></div>
        <div class="kv"><span style="color:var(--muted)">52W Low</span><strong id="oLow">—</strong></div>
        <div class="kv"><span style="color:var(--muted)">52W High</span><strong id="oHigh">—</strong></div>
        <div class="kv"><span style="color:var(--muted)">From Low</span><strong id="oFromLow">—</strong></div>
        <div class="kv"><span style="color:var(--muted)">From High</span><strong id="oFromHigh">—</strong></div>
      </div>
    </div>
  </div>
</div>

<script>
const $ = (id) => document.getElementById(id);
const nf = new Intl.NumberFormat(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
let table = [];

function csvUrlFromAny(input){
  if(!input) return "";
  const raw = input.trim();
  if(/\/pub\?/.test(raw) && /output=csv/.test(raw)) return raw; // already CSV publish link
  try{
    const u = new URL(raw);
    let gid = u.searchParams.get("gid") || "";
    if(!gid && u.hash && u.hash.includes("gid=")){
      const m = u.hash.match(/gid=(\d+)/); gid = m? m[1] : "";
    }
    if(u.pathname.endsWith("/pubhtml")){
      u.pathname = u.pathname.replace("/pubhtml","/pub");
      u.search = ""; u.searchParams.set("output","csv"); if(gid) u.searchParams.set("gid", gid);
      return u.toString();
    }
    return raw; // edit/view links won't load unless published
  }catch(e){
    return raw.replace(/\/pubhtml.*/,"/pub?output=csv");
  }
}

function parseCSV(text){
  const rows=[]; let i=0, field="", row=[], inQ=false;
  while(i<text.length){
    const c=text[i];
    if(inQ){
      if(c==='"') { if(text[i+1]==='"'){ field+='"'; i+=2; continue;} inQ=false; i++; continue; }
      field+=c; i++; continue;
    } else {
      if(c==='"'){ inQ=true; i++; continue; }
      if(c===','){ row.push(field); field=""; i++; continue; }
      if(c==='\r'){ i++; continue; }
      if(c==='\n'){ row.push(field); rows.push(row); field=""; row=[]; i++; continue; }
      field+=c; i++; continue;
    }
  }
  row.push(field); rows.push(row);
  return rows.filter(r=>r.some(cell=>String(cell).trim()!==""));
}

function toRecords(rows){
  if(!rows.length) return [];
  const headers = rows[0].map(h=>String(h||"").trim().toLowerCase());
  const idx = {
    ticker: findHeader(headers,["ticker","symbol"]),
    low: findHeader(headers,["52w low","52-week low","52 week low","low 52w"]),
    high: findHeader(headers,["52w high","52-week high","52 week high","high 52w"]),
    current: findHeader(headers,["current","price","last"])
  };
  const missing = Object.entries(idx).filter(([k,v])=>v===-1).map(([k])=>k);
  if(missing.length) throw new Error("Missing columns: "+missing.join(", "));
  const out=[];
  for(let r=1;r<rows.length;r++){
    const row=rows[r];
    const rec={
      ticker:(row[idx.ticker]||"").trim(),
      low:toNum(row[idx.low]), high:toNum(row[idx.high]), current:toNum(row[idx.current])
    };
    if(rec.ticker) out.push(rec);
  }
  return out;
}
function findHeader(headers, aliases){
  for(const a of aliases){
    const norm=a.replace(/[-\s_]/g,"");
    const i=headers.findIndex(h=>h===a||h.replace(/[-\s_]/g,"")===norm);
    if(i!==-1) return i;
  }
  return -1;
}
function toNum(v){ if(v==null) return NaN; const s=String(v).replace(/[%₹,$\s]/g,""); const n=parseFloat(s); return Number.isFinite(n)?n:NaN; }
function fmt(n){ return Number.isFinite(n)? nf.format(n) : "—"; }

function calcAndRender(rec){
  const output=$("output"), badge=$("badge"), percentEl=$("percent");
  const fill=document.querySelector('.bar .fill'); const thumb=document.querySelector('.bar .thumb');
  if(!rec){ output.hidden=true; return; }
  const {ticker,low,high,current}=rec;
  if(!Number.isFinite(low)||!Number.isFinite(high)||!Number.isFinite(current)||!(high>low)){
    output.hidden=false; percentEl.textContent='Missing or invalid numbers.'; badge.textContent=''; badge.className='pill';
    ["oTicker","oCurrent","oLow","oHigh","oFromLow","oFromHigh"].forEach(id=>$(id).textContent='—');
    fill.style.width='0%'; thumb.style.left='0%'; return;
  }
  const range=high-low; const pos=((current-low)/range)*100; const pct=Math.max(0,Math.min(100,pos));
  const fromLow=current-low, fromHigh=high-current;
  $("oTicker").textContent=ticker; $("oCurrent").textContent=fmt(current); $("oLow").textContent=fmt(low); $("oHigh").textContent=fmt(high);
  $("oFromLow").textContent=fmt(fromLow); $("oFromHigh").textContent=fmt(fromHigh);
  output.hidden=false; percentEl.textContent=nf.format(pos)+'%'; fill.style.width=pct+'%'; thumb.style.left=pct+'%';
  badge.className='pill'; if(current<low){ badge.textContent='Below 52-week low'; badge.classList.add('warn'); }
  else if(current>high){ badge.textContent='Above 52-week high'; badge.classList.add('ok'); }
  else { badge.textContent='Within 52-week range'; badge.classList.add('ok'); }
}

async function fetchSheet(){
  const raw=$("csvUrl").value.trim(); if(!raw){ alert('Paste a Published link.'); return; }
  const converted=csvUrlFromAny(raw);
  let text='';
  try{ const res=await fetch(converted,{mode:'cors'}); if(!res.ok) throw new Error('HTTP '+res.status); text=await res.text(); }
  catch(e){ const prox='https://api.allorigins.win/raw?url='+encodeURIComponent(converted); const r2=await fetch(prox); if(!r2.ok) throw new Error('HTTP '+r2.status+' (CORS)'); text=await r2.text(); }
  const rows=parseCSV(text); table=toRecords(rows); if(!table.length) throw new Error('No rows parsed');
  const sel=$("ticker"); sel.innerHTML='<option value="">Select ticker…</option>'+table.map((r,i)=>`<option value="${i}">${r.ticker}</option>`).join('');
  sel.disabled=false; $("recalc").disabled=false; $("output").hidden=true; updateCounter();
}

function stepTicker(offset){
  const sel=$("ticker"); if(sel.options.length<=1) return; // only placeholder
  let i=sel.selectedIndex; if(i<=0) i=1; i+=offset; const min=1, max=sel.options.length-1;
  if(i<min) i=max; if(i>max) i=min; sel.selectedIndex=i; const idx=parseInt(sel.value,10); if(Number.isInteger(idx)) calcAndRender(table[idx]); updateCounter();
}

function updateCounter(){
  const sel=$("ticker"); const n=sel.options.length-1; const i=Math.max(0, sel.selectedIndex-1)+1; $("counter").textContent = n>0 && sel.selectedIndex>0 ? `${i} / ${n}` : '';
}

// Events
$("load").addEventListener('click', fetchSheet);
$("clear").addEventListener('click', ()=>{ $("csvUrl").value=''; $("ticker").innerHTML='<option value="">Select ticker…</option>'; $("ticker").disabled=true; $("recalc").disabled=true; $("output").hidden=true; table=[]; updateCounter(); });
$("ticker").addEventListener('change', e=>{ const idx=parseInt(e.target.value,10); if(Number.isInteger(idx)) calcAndRender(table[idx]); updateCounter(); });
$("recalc").addEventListener('click', ()=>{ const sel=$("ticker"); const idx=parseInt(sel.value,10); if(Number.isInteger(idx)) calcAndRender(table[idx]); });
$("prev").addEventListener('click', ()=>stepTicker(-1));
$("next").addEventListener('click', ()=>stepTicker(1));
// Keyboard arrows for prev/next
window.addEventListener('keydown', (e)=>{ if(e.key==='ArrowLeft') stepTicker(-1); if(e.key==='ArrowRight') stepTicker(1); });
</script>
</body>
</html>
